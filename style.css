const video = document.getElementById("webcam");
const itemDisplay = document.getElementById("itemDisplay");
const cartList = document.getElementById("cartList");

let model = null;
let currentItemIndex = 0;
let cart = [];
let lastGesture = "";
let lastActionTime = 0;

const items = [
    "Milk", "Bread", "Fruits", "Rice", "Toothpaste",
    "Pickles", "Soap", "Biscuits", "Chips", "Cream"
];

const modelParams = {
    flipHorizontal: true,
    maxNumBoxes: 1,
    iouThreshold: 0.5,
    scoreThreshold: 0.7,
};

function startVideo() {
    handTrack.startVideo(video).then(status => {
        if (status) {
            console.log("Webcam started!");
            runDetection();
        } else {
            console.log("Please enable camera access.");
        }
    }).catch(err => {
        console.error("Error starting video:", err);
    });
}

function runDetection() {
    model.detect(video).then(predictions => {
        const now = Date.now();

        if (predictions.length > 0) {
            const gesture = predictions[0].label;

            if (gesture !== lastGesture || now - lastActionTime > 2000) {
                lastGesture = gesture;
                lastActionTime = now;

                if (gesture === "open") {
                    const currentItem = items[currentItemIndex];
                    if (!cart.includes(currentItem)) {
                        cart.push(currentItem);
                        updateCart();
                    } else {
                        alert(`${currentItem} already in cart!`);
                    }
                } else if (gesture === "point") {
                    currentItemIndex = (currentItemIndex + 1) % items.length;
                    updateItemDisplay();
                } else if (gesture === "closed") {
                    if (cart.length > 0) {
                        alert("âœ… Checkout complete!");
                        cart = [];
                        updateCart();
                    } else {
                        alert("Your cart is empty.");
                    }
                }
            }
        }

        requestAnimationFrame(runDetection);
    });
}

function updateItemDisplay() {
    itemDisplay.innerText = items[currentItemIndex];
}

function updateCart() {
    cartList.innerHTML = "";
    cart.forEach(item => {
        const li = document.createElement("li");
        li.innerText = item;
        cartList.appendChild(li);
    });
}

handTrack.load(modelParams).then(lmodel => {
    model = lmodel;
    updateItemDisplay();
    startVideo();
});
